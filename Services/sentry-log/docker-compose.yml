version: "3.9"

x-sentry-environment: &sentry-environment
  SENTRY_SECRET_KEY: ${SENTRY_SECRET_KEY}
  SENTRY_POSTGRES_HOST: ${DB_HOST}
  SENTRY_DB_PORT: ${DB_PORT}
  SENTRY_DB_USER: ${DB_USER}
  SENTRY_DB_PASSWORD: ${DB_PASSWORD}
  SENTRY_DB_NAME: ${DB_NAME}
  SENTRY_REDIS_HOST: ${REDIS_HOST}
  SENTRY_REDIS_PORT: ${REDIS_PORT}
  SENTRY_REDIS_DB: ${REDIS_DB}
  SENTRY_REDIS_PASSWORD: ${REDIS_PASSWORD}
  SENTRY_SERVER_EMAIL: ${SENTRY_SERVER_EMAIL}
  SENTRY_EMAIL_HOST: ${EMAIL_HOST}
  SENTRY_EMAIL_PORT: ${EMAIL_PORT}
  SENTRY_EMAIL_USER: ${EMAIL_USER}
  SENTRY_EMAIL_PASSWORD: ${EMAIL_PASSWORD}
  SENTRY_EMAIL_USE_TLS: ${EMAIL_USE_TLS}

services:
  sentry:
    image: sentry:latest
    container_name: sentry-web
    restart: unless-stopped
    environment:
      <<: *sentry-environment
    ports:
      - "8001:9000"
    networks:
      - global_network
    volumes:
      - sentry-data:/var/lib/sentry/files
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/_health/" ]
      interval: 30s
      timeout: 10s
      retries: 3

  sentry-cron:
    image: sentry:latest
    container_name: sentry-cron
    restart: unless-stopped
    command: "sentry run cron"
    environment:
      <<: *sentry-environment
    networks:
      - global_network
    depends_on:
      - sentry

  sentry-worker:
    image: sentry:latest
    container_name: sentry-worker
    restart: unless-stopped
    command: "sentry run worker"
    environment:
      <<: *sentry-environment
    networks:
      - global_network
    depends_on:
      - sentry

volumes:
  sentry-data:
    driver: local

networks:
  global_network:
    external: true
